## Cập Nhật Hồ Sơ Người Dùng với Server Actions

### Tổng Quan

Bài học này hướng dẫn cách sử dụng [[Server Actions]] trong NextJS để cho phép khách (guests) cập nhật thông tin hồ sơ của họ. Quy trình bao gồm việc thiết lập form, xử lý dữ liệu trên server và cập nhật vào [[Supabase]].

### Cấu Trúc Component

**Kỹ thuật truyền Server Component vào Client Component**

Trong trang `account/profile/page.js`, ta sử dụng kỹ thuật quan trọng: truyền [[Server Component]] như một prop vào [[Client Component]]. Component `UpdateProfileForm` là client component nhưng nhận server component làm children.

```javascript
// page.js (Server Component)
async function Page() {
  const session = await auth();
  const guest = await getGuest(session.user.email);
  
  return (
    <UpdateProfileForm guest={guest}>
      <SelectCountry defaultCountry={guest.nationality} />
    </UpdateProfileForm>
  );
}
```

**Lý do lấy dữ liệu ở Server Component**

- Không fetch dữ liệu trong client component
- Fetch dữ liệu ở page (server component) rồi truyền xuống
- Tận dụng được khả năng async/await trực tiếp


### Thiết Lập Form với Default Values

**Pre-populate dữ liệu form**

Trong `UpdateProfileForm` component, sử dụng thuộc tính `defaultValue` của React để điền trước dữ liệu:

```javascript
function UpdateProfileForm({ guest, children }) {
  const { fullName, email, nationality, nationalID, countryFlag } = guest;
  
  return (
    <form action={updateGuest}>
      <input 
        name="fullName" 
        defaultValue={fullName} 
        disabled 
      />
      <input 
        name="email" 
        defaultValue={email} 
        disabled 
      />
      <input 
        name="nationalID" 
        defaultValue={nationalID || ""} 
      />
      {children}
    </form>
  );
}
```

**Lưu ý về các trường disabled**

- Trường `fullName` và `email` được vô hiệu hóa (disabled)
- Người dùng chỉ có thể cập nhật `nationality` và `nationalID`
- Dữ liệu từ các trường disabled có thể không được gửi đến server action


### Tạo Server Action

**Định nghĩa trong module riêng**

Do `UpdateProfileForm` là client component, không thể định nghĩa server action trực tiếp bên trong. Phải tạo trong module riêng `actions.js`:

```javascript
'use server'

export async function updateGuest(formData) {
  console.log('server action');
}
```

**Directive `use server`**

- Đánh dấu file này chứa [[Server Actions]]
- Hoạt động như cầu nối từ client về server
- Mọi hàm export từ module này đều trở thành server action
- Khác với việc định nghĩa server component

**Gắn Server Action vào Form**

```javascript
<form action={updateGuest}>
  {/* form fields */}
</form>
```

Khi form được submit, server action tự động được gọi mà không cần JavaScript bổ sung.

### Xử Lý Form Data

**Tự động nhận FormData**

Server action tự động nhận [[FormData]] từ form thông qua native FormData API:

```javascript
export async function updateGuest(formData) {
  // formData tự động được truyền vào
}
```

**Yêu cầu thuộc tính `name`**

Mỗi input field phải có thuộc tính `name` để FormData có thể nhận diện:

```javascript
<input name="fullName" />
<input name="email" />
<input name="nationalID" />
<select name="nationality" />
```

Các giá trị `name` nên khớp với tên cột trong database để dễ xử lý.

**Kỹ thuật encode nhiều giá trị trong một field**

Component `SelectCountry` sử dụng trick để encode cả tên quốc gia và cờ trong một giá trị duy nhất:

```javascript
<option value={`${country.name}%${country.flag}`}>
  {country.name}
</option>
```

Sau đó split để lấy lại cả hai giá trị:

```javascript
const [nationality, countryFlag] = formData.get('nationality').split('%');
```


### Xác Thực và Ủy Quyền

**Kiểm tra Authentication**

Luôn kiểm tra user đã đăng nhập trước khi thực hiện server action:

```javascript
export async function updateGuest(formData) {
  const session = await auth();
  
  if (!session) {
    throw new Error('You must be logged in');
  }
  
  // Tiếp tục xử lý...
}
```

**Lý do quan trọng**

- Server actions chạy trên backend, cần đảm bảo authorization
- Chỉ user đã đăng nhập mới được phép cập nhật dữ liệu
- Sử dụng `throw new Error()` thay vì try-catch, lỗi sẽ được caught bởi [[Error Boundary]] gần nhất


### Validate Dữ Liệu Đầu Vào

**Nguyên tắc: Treat all inputs as unsafe**

Luôn coi mọi input là không an toàn và cần validate:

```javascript
// Lấy dữ liệu từ formData
const nationalID = formData.get('nationalID');
const [nationality, countryFlag] = formData.get('nationality').split('%');
```

**Sử dụng Regex để validate**

Ví dụ validate National ID phải là chuỗi alphanumeric, độ dài 6-12 ký tự:

```javascript
const regex = /^[a-zA-Z0-9]{6,12}$/;

if (!regex.test(nationalID)) {
  throw new Error('Please provide a valid national ID');
}
```

**Sử dụng AI tools để tạo regex**

- Có thể dùng ChatGPT để generate regex cho các pattern phức tạp
- Nhớ luôn test kỹ code được generate
- Tiết kiệm thời gian thay vì tìm trên Stack Overflow


### Cập Nhật Database

**Lấy Guest ID từ Session**

Sử dụng `guestID` đã được thêm vào session trong phần authentication:

```javascript
const session = await auth();
const guestID = session.user.guestID;
```

**Thực hiện update với Supabase**

```javascript
const updateData = {
  nationality,
  countryFlag, 
  nationalID
};

const { error } = await supabase
  .from('guests')
  .update(updateData)
  .eq('id', guestID);

if (error) {
  throw new Error('Guest could not be updated');
}
```


### Vấn Đề với Browser Cache

**Router Cache gây ra dữ liệu cũ**

Sau khi cập nhật thành công, nếu navigate đi rồi quay lại trang profile, dữ liệu hiển thị vẫn là dữ liệu cũ. Nguyên nhân:

- NextJS lưu cache [[Dynamic Routes]] trong 30 giây
- Dữ liệu cũ được serve từ [[Router Cache]] (Browser Cache)
- Chỉ hard reload mới thấy dữ liệu mới

**Giải pháp**

Cần invalidate cache sau khi cập nhật, sẽ được xử lý trong bài học tiếp theo.

### Debugging với Network Tab

**Kiểm tra POST request**

Khi form submit, có thể xem request trong DevTools:

- Method: POST
- Payload: chứa form values và action ID
- Action ID: NextJS dùng để xác định server action nào được gọi
- URL endpoint được NextJS tự động tạo

**RSC Payload**

Response có format đặc biệt của [[React Server Components]] (RSC), chứa thông tin NextJS sử dụng internally.

### Ghi Chú Thêm

**Best Practices với Server Actions**

- Luôn validate input data
- Kiểm tra authentication/authorization
- Throw errors thay vì dùng try-catch, để Error Boundary xử lý
- Sử dụng form action thay vì onClick handlers
- Tận dụng native FormData API

**Ưu điểm của phương pháp này**

- Không cần JavaScript phía client
- Không cần quản lý state phức tạp
- Không cần tự tạo API endpoints
- Progressive enhancement: form vẫn hoạt động khi JavaScript disabled

**Liên kết:** [[Server Actions]], [[FormData]], [[Client Component]], [[Server Component]], [[Supabase]], [[Authentication]], [[Router Cache]], [[Error Boundary]], [[React Server Components]], [[Dynamic Routes]]

