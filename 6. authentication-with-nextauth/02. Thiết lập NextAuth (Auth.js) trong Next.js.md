## Thiết lập NextAuth/Auth.js với Google Provider

### Giới thiệu về Auth.js

[[NextAuth]] đang được đổi tên thành [[Auth.js]] để hỗ trợ nhiều framework hơn, không chỉ Next.js. Đây là một thư viện (library) giúp đơn giản hóa việc xác thực, **không phải là dịch vụ xác thực độc lập** như Supabase Authentication.

**Ưu điểm của Auth.js:**

- Dễ dàng tích hợp nhiều nhà cung cấp (providers): Google, GitHub, Facebook...
- Có thể sử dụng credentials provider để xác thực với database riêng
- Miễn phí hoàn toàn khi sử dụng các provider như Google/GitHub

**So sánh với các giải pháp khác:**

- **[[Clerk]]** hoặc **[[Lucia]]**: Dịch vụ all-in-one, cung cấp database người dùng và UI components sẵn có, nhưng phải trả phí sau một thời gian
- **[[Supabase Auth]]**: Dịch vụ xác thực tích hợp sẵn của Supabase, đã sử dụng trong phần đầu khóa học


### Thiết lập Environment Variables

Tạo hoặc chỉnh sửa file `.env.local` với các biến môi trường sau (đảm bảo chính tả chính xác):

```env
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-generated-secret-here
AUTH_GOOGLE_ID=your-google-client-id
AUTH_GOOGLE_SECRET=your-google-client-secret
```

**Lưu ý quan trọng:**

- `NEXTAUTH_URL`: URL ứng dụng đang chạy (ví dụ: `localhost:3000` hoặc `127.0.0.1:3001`)
- `NEXTAUTH_SECRET`: Sử dụng công cụ [Generate Secret](https://generate-secret.vercel.app) của Vercel để tạo secret an toàn
- Các biến này sẽ được Auth.js tự động đọc, không cần khai báo ở nơi khác


### Cấu hình Google OAuth Console

Truy cập [Google Developer Console](https://console.developers.google.com) và thực hiện các bước sau:

**Bước 1: Tạo project mới**

- Đặt tên project (ví dụ: "The Wild Oasis")
- Chọn project vừa tạo

**Bước 2: Cấu hình OAuth Consent Screen**

- Chọn **APIs \& Services** → **OAuth consent screen**
- Chọn **External** (Internal chỉ dành cho Google Workspace users)
- Điền thông tin:
    - App name: The Wild Oasis
    - Support email: Gmail của bạn
    - Logo (tùy chọn)
- Thêm test users: Chỉ những người trong danh sách này mới có thể test ứng dụng trong giai đoạn development
- Save và continue qua các bước còn lại

**Bước 3: Tạo OAuth Client Credentials**

- Chọn **Credentials** → **Create Credentials** → **OAuth client ID**
- Application type: **Web application**
- Thêm **Authorized JavaScript origins**:

```
http://localhost:3000
```

- Thêm **Authorized redirect URIs**:

```
http://localhost:3000/api/auth/callback/google
```

- Click **Create**

**Bước 4: Lưu credentials**

- Copy **Client ID** vào `AUTH_GOOGLE_ID`
- Copy **Client Secret** vào `AUTH_GOOGLE_SECRET`
- Lưu ý: Có thể truy cập lại credentials này sau nếu cần

**Sau khi deploy production:**

- Cần thêm production URLs vào Authorized origins và Redirect URIs
- Publish app để chuyển từ Testing sang Production mode


### Cài đặt và cấu hình Auth.js

**Cài đặt thư viện:**

```bash
npm install next-auth@beta
```

**Lưu ý:** Hiện tại cần sử dụng `@beta` để cài đặt version 5 (Auth.js). Kiểm tra documentation để xem liệu còn cần thiết trong tương lai.

**Tạo file cấu hình `app/_lib/auth.js`:**

```javascript
import NextAuth from "next-auth";
import Google from "next-auth/providers/google";

const authConfig = {
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
    }),
  ],
};

export const {
  auth,
  handlers: { GET, POST },
} = NextAuth(authConfig);
```

**Giải thích:**

- `providers`: Danh sách các nhà cung cấp xác thực (có thể thêm GitHub, Facebook...)
- `auth`: Function dùng trong server components để lấy thông tin session
- `GET, POST`: Route handler functions cho các API routes


### Tạo API Route Handler

**Tạo file `app/api/auth/[...nextauth]/route.js`:**

```javascript
export { GET, POST } from "@/app/_lib/auth";
```

**Ý nghĩa của `[...nextauth]`:**

- **Catch-all segment**: Xử lý tất cả URLs bắt đầu với `/api/auth/`
- Ví dụ: `/api/auth/signin`, `/api/auth/signout`, `/api/auth/providers`
- Auth.js tự động tạo các routes này để quản lý authentication flow


### Kiểm tra cấu hình

**Truy cập các routes để kiểm tra:**

1. **Sign in page**: `http://localhost:3000/api/auth/signin`
    - Hiển thị nút "Sign in with Google"
    - Nếu thấy nút này → cấu hình thành công
2. **Providers endpoint**: `http://localhost:3000/api/auth/providers`
    - Trả về JSON với thông tin providers đã cấu hình

**Test đăng nhập:**

- Click "Sign in with Google"
- Chọn Google account
- Xem OAuth consent screen với tên app đã cấu hình
- Click Continue

**Lưu ý hiện tại:** Chưa xử lý kết quả đăng nhập, sẽ thực hiện ở bài tiếp theo.

### Xử lý lỗi thường gặp

**Checklist khi gặp lỗi:**

- Kiểm tra tất cả environment variables được đặt tên chính xác (case-sensitive)
- Xác nhận `NEXTAUTH_URL` khớp với URL đang chạy ứng dụng
- Đảm bảo Redirect URI trong Google Console khớp chính xác: `/api/auth/callback/google`
- Kiểm tra Client ID và Secret được copy đúng từ Google Console
- Xác nhận đã thêm test users vào OAuth consent screen
- Restart development server sau khi thay đổi environment variables


### Tài liệu tham khảo

**Lưu ý về documentation:**
Do đang trong giai đoạn chuyển đổi từ NextAuth v4 sang Auth.js v5, tài liệu hiện tại còn nhiều phần không nhất quán. Một số phần vẫn dành cho v4, số khác cho v5. Do đó, việc làm theo khóa học có cấu trúc sẽ hiệu quả hơn.

**Mở rộng trong tương lai:**

- Thêm providers khác: GitHub, Facebook, Email...
- Sử dụng **Credentials Provider** để xác thực với database riêng
- Cấu hình callbacks và events để tùy chỉnh authentication flow

**Liên kết:** [[NextAuth]], [[Auth.js]], [[Google OAuth]], [[OAuth Consent Screen]], [[Environment Variables]], [[Route Handler]], [[Catch-all Segment]], [[Providers]], [[Authentication Flow]], [[API Routes]]

