## Thực hành Server Side Rendering thủ công

Bài học này hướng dẫn tạo một phiên bản cơ bản của Server Side Rendering (SSR) bằng Node.js server đơn giản và các ReactDOM API. Mục đích là hiểu rõ các thành phần liên quan trong ứng dụng SSR điển hình, giúp việc sử dụng SSR trong Next.js sau này không còn quá "huyền bí".

### Thiết lập Node.js server cơ bản

Đầu tiên, tạo file `server.js` và khởi tạo project Node.js:

```bash
npm init
```

Sau đó tạo web server bằng module HTTP built-in của Node:

```javascript
const { createServer } = require('http');
const { parse } = require('url');

const server = createServer((request, response) => {
  const pathname = parse(request.url, true).pathname;
  
  if (pathname === '/') {
    response.end('Hello world');
  } else if (pathname === '/test') {
    response.end('Test page');
  } else {
    response.end('URL cannot be found');
  }
});

server.listen(8000, () => {
  console.log('Listening for requests on port 8000');
});
```

Chạy server với chế độ watch (yêu cầu Node.js version 20+):

```bash
node --watch server.js
```


### Gửi file HTML từ server

Thay vì gửi text đơn giản, tạo file `index.html` và đọc nó từ server:

```javascript
const { readFileSync } = require('fs');

const htmlTemplate = readFileSync(`${__dirname}/index.html`, 'utf-8');

// Trong createServer callback:
if (pathname === '/') {
  response.writeHead(200, { 'Content-Type': 'text/html' });
  response.end(htmlTemplate);
}
```


### Tích hợp React với JSX

Để sử dụng JSX trong Node.js, cần cài đặt các gói Babel:

```bash
npm install -D @babel/core @babel/preset-env @babel/preset-react @babel/register
npm install react react-dom
```

Tạo file `start.js` để đăng ký JSX:

```javascript
require('@babel/register')({
  extensions: ['.js', '.jsx']
});

require('./server.js');
```

Trong `server.js`, import React và các component:

```javascript
const React = require('react');
const { renderToString } = require('react-dom/server');

// Component React
function Home() {
  return (
    <div>
      <h1>Menu</h1>
      {/* JSX content */}
    </div>
  );
}
```


### Render React thành HTML

Sử dụng `renderToString()` để chuyển React component thành HTML string:

```javascript
const renderedReact = renderToString(<Home />);

// Thay placeholder trong HTML template
const htmlTemplate = readFileSync(`${__dirname}/index.html`, 'utf-8');
const html = htmlTemplate.replace('<!--CONTENT-->', renderedReact);

response.writeHead(200, { 'Content-Type': 'text/html' });
response.end(html);
```

Trong `index.html`, đặt placeholder:

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SSR Demo</title>
</head>
<body>
  <div id="root"><!--CONTENT--></div>
</body>
</html>
```


### Vấn đề của SSR thuần túy

Khi render React components thành HTML tĩnh, trang web sẽ mất đi tính tương tác (interactivity). Các event handlers, state hooks như `useState` không hoạt động vì:

- Server chỉ render HTML tĩnh
- Không có JavaScript code được gửi kèm để xử lý sự kiện
- React hooks không tồn tại trong HTML thuần

Ví dụ: Nút bấm với onClick handler sẽ không có phản ứng gì khi click.

### Ghi chú

Đây là một bản demo đơn giản để hiểu cơ chế SSR cơ bản. Trong thực tế, Next.js và các framework khác xử lý phức tạp hơn nhiều, bao gồm cả quá trình hydration (sẽ được học ở bài tiếp theo) để khôi phục tính tương tác cho ứng dụng.

Bài học tiếp theo sẽ giải quyết vấn đề interactivity thông qua khái niệm hydration - một khía cạnh quan trọng của Server Side Rendering.

**Liên kết:** [[Server Side Rendering]], [[React]], [[Node.js]], [[ReactDOM]], [[Hydration]], [[JSX]], [[Babel]]

