## React Server Components - Kiến trúc Full-stack mới của React

Bài học này giới thiệu một trong những chủ đề quan trọng và nóng nhất của React hiện nay: [[React Server Components]] (RSC). Đây là một paradigm (mô hình kiến trúc) hoàn toàn mới thay đổi cách chúng ta xây dựng ứng dụng React.

### Tại sao cần React Server Components

**Vấn đề với ứng dụng 100% Client-side**

Trong ứng dụng React truyền thống, UI là một hàm của state thay đổi theo thời gian. Khi state cập nhật, ứng dụng re-render và hiển thị các phần UI khác nhau. Tuy nhiên, cách tiếp cận này có hai nhược điểm lớn:

- Cần tải xuống rất nhiều JavaScript lên máy người dùng, ảnh hưởng nghiêm trọng đến hiệu năng
- Gặp vấn đề [[client-server waterfall]]: khi nhiều component trên trang cần fetch dữ liệu lần lượt, với dữ liệu của component này phụ thuộc vào component kia

**Ứng dụng 100% Server-side truyền thống**

Trước đây với PHP, chúng ta có:

- Không có tính tương tác và không có component
- Dễ dàng fetch dữ liệu trực tiếp từ nguồn dữ liệu (database)
- Không cần xây dựng API để giao tiếp giữa frontend và backend
- Không cần JavaScript, trang tải nhanh hơn
- UI là hàm của data, không phải state

**Giải pháp kết hợp**

React Server Components sinh ra để kết hợp ưu điểm của cả hai cách tiếp cận, tạo ra UI vừa là hàm của state vừa là hàm của data. Thay vì phải chọn 100% client hoặc 100% server, RSC cho phép có cả component trên server và trên client, đạt được:

- Tính tương tác
- Gần với nguồn dữ liệu
- Không cần ship JavaScript cho một số component


### React Server Components là gì

**Định nghĩa**

React Server Components (RSC) là một kiến trúc full-stack hoàn toàn mới để xây dựng ứng dụng React. Nó đưa server trở thành "first class citizen" trong ứng dụng React, có nghĩa là server giờ đây là một phần không thể thiếu của component tree.

**Hai loại component**

RSC giới thiệu hai loại component:

- **[[Server Components]]**: component chỉ render trên server, không bao giờ trên client
    - Nhiệm vụ chính là fetch dữ liệu ngay trên server
    - Không có tính tương tác, không có state
    - Không cần JavaScript trong bundle để hoạt động (disappearing code)
    - Cho phép xây dựng backend của ứng dụng bằng React
- **[[Client Components]]**: component chạy hoàn toàn trên client (component React truyền thống)
    - Chịu trách nhiệm về tính tương tác
    - Có thể sử dụng state và hooks
    - Phần UI là hàm của state


### Kích hoạt RSC trong ứng dụng

**Lưu ý quan trọng**

React Server Components không được kích hoạt mặc định trong ứng dụng React mới. Ví dụ, nếu bạn tạo project React bằng Vite như trước đây, bạn sẽ không có kiến trúc này.

**Vai trò của Framework**

React cung cấp kiến trúc RSC, nhưng các framework full-stack như [[Next.js]] hoặc Remix mới thực sự triển khai nó. Trong Next.js App Router:

- [[Server Components]] trở thành loại component mặc định
- Client Components trở thành "opt-in" (tự chọn sử dụng)
- Sử dụng directive `use client` ở đầu module để khai báo Client Component

```javascript
'use client'

export default function InteractiveButton() {
  const [count, setCount] = useState(0);
  // Component này cần state nên phải là Client Component
}
```


### Ví dụ thực tế: Wild Oasis App

**Phân tích component tree**

Trong ứng dụng Wild Oasis, các component được phân chia như sau:

**Server Components (màu vàng):**

- `Sidebar`, `Header`, `Main`: không tương tác, không cần JavaScript
- `Avatar`: hiển thị ảnh và tên, fetch data từ server
- `Table`: fetch và render dữ liệu cabin
- `CabinRow`: hiển thị từng hàng dữ liệu

**Client Components (cần JavaScript):**

- `DarkModeToggle`: người dùng có thể click để chuyển chế độ
- `Filter`, `SortBy`: cần tương tác để lọc và sắp xếp
- `Menu` và các button con: mở menu và xử lý các thao tác

**Khái niệm Server-Client Boundary**

- Khi sử dụng `use client`, bạn tạo ra [[server-client boundary]]
- Các component con của Client Component không cần khai báo `use client` lại
- Chúng đã nằm trong client sub-tree rồi


### So sánh Client Components vs Server Components

**Component mặc định**

- Server Components: mặc định trong RSC model
- Client Components: cần opt-in với `use client`

**State và Hooks**

- Server Components: không thể có state, không sử dụng hooks
- Client Components: có thể sử dụng state và mọi hooks

**Props**

- Server Components: có thể truyền props giữa các Server Components và từ Server sang Client Components
- Lưu ý: props phải serializable (có thể chuyển đổi thành format dễ truyền tải)
- Không thể truyền functions hoặc classes từ Server sang Client Components

**Data Fetching**

- Server Components: cách native, ưu tiên để fetch data
    - Có thể sử dụng async/await trực tiếp ở top-level
    - Truyền data sang client qua props
- Client Components: vẫn có thể fetch data
    - Nên sử dụng thư viện như React Query

**Import và Render**

- Server Components: có thể import và render cả Server và Client Components
- Client Components: chỉ có thể import Client Components khác
    - Không thể import Server Components
    - Nhưng có thể render Server Components nếu được truyền qua props

**Re-render**

- Server Components: re-render khi URL thay đổi (người dùng navigate)
    - Thường được gắn với routes cụ thể trong framework
- Client Components: re-render khi state của chính nó hoặc parent state thay đổi


### Mental Model của RSC

**React truyền thống**

Components → View → User Interaction → Update State → Re-render Components → Updated View

**React với Server Components**

Mô hình core vẫn giữ nguyên, nhưng có thêm lớp outer layer:

- **Client Components**: xử lý tương tác, state, và hiển thị view
- **Server Components**: chạy trên server, fetch data, hiển thị view
- **Kết nối**: Server và Client Components được kết nối qua props (bridge across server-client boundary)
- **URL Changes**: khi URL thay đổi → Server Components re-render → fetch data mới → updated view

Cả hai loại component đều đóng góp vào cùng một view nhưng sử dụng các cơ chế khác nhau. Không có loại nào tốt hơn loại kia - chúng có mục đích khác nhau và đều quan trọng.

### Ưu điểm của RSC

**Viết React cho cả Frontend và Backend**

- Đóng gói tất cả server-side concerns vào components
- Xây dựng full-stack app chỉ bằng components
- Một codebase duy nhất cho frontend và backend

**Không cần xây dựng API**

- Server Components có truy cập trực tiếp đến data source (database)
- Gửi trang đã render thay vì chỉ gửi JSON data
- Lưu trữ API keys an toàn (không lo lộ ở client)

**Hiệu năng tốt hơn**

- Loại bỏ client-server waterfalls: fetch tất cả data cần thiết trên server một lần
- [[Disappearing code]]: Server Components không cần JavaScript ở browser
- Import thư viện lớn trong Server Components mà không tăng bundle size
- Tốt cho libraries dùng để render data: CMS, embedding tweets, syntax highlighting, v.v.


### Nhược điểm của RSC

**Độ phức tạp tăng**

- React trở nên phức tạp hơn với nhiều khái niệm mới cần học
- Tuy nhiên vẫn manageable (có thể quản lý được)

**Giới hạn API**

- Context API và hooks không hoạt động trên Server Components
- Cần đưa ra nhiều quyết định hơn: component này nên là Server hay Client? Fetch data ở đâu?

**Cần Framework**

- RSC chỉ có thể được triển khai trong framework (Next.js, Remix, etc.)
- Không thể tự setup RSC trong Vite app thông thường
- Phải "buy into" một framework để sử dụng Server Components

**Mobile App**

- Nếu cần cả web app và mobile app, vẫn phải xây dựng API riêng
- Mobile app không thể sử dụng Server Components trực tiếp


### Kết luận

Mặc dù có một số nhược điểm, ưu điểm của React Server Components hoàn toàn vượt trội. Đây là một hướng đi đúng đắn của React, mang lại hiệu năng tốt hơn và trải nghiệm phát triển tự nhiên hơn khi xây dựng full-stack applications.

***

**Liên kết:** [[React Server Components]], [[Server Components]], [[Client Components]], [[Next.js]], [[server-client boundary]], [[client-server waterfall]], [[disappearing code]], [[use client]], [[App Router]], [[full-stack architecture]]

