## Mối quan hệ giữa RSC và Server-Side Rendering

Bài học này làm rõ sự khác biệt và cách RSC (React Server Components) tương tác với SSR (Server-Side Rendering) trong Next.js, giải quyết một trong những hiểu lầm phổ biến nhất về kiến trúc này.

### Ôn tập: Server-Side Rendering (SSR) cơ bản

SSR tại runtime (còn gọi là Dynamic SSR) hoạt động như sau:

- Bắt đầu từ component tree
- Render thành Virtual DOM
- Chuyển đổi thành HTML
- Gửi HTML đến browser của user
- Gửi thêm React bundle (React library + component code) để hydrate HTML
- **Hydration:** Quá trình thêm lại tính tương tác vào HTML tĩnh, biến nó thành React App có đầy đủ chức năng

**Công thức đơn giản:** Lấy React component tree → render thành HTML → gửi đến browser

### RSC không phải là SSR

**Điểm quan trọng:** RSC và SSR là hai công nghệ hoàn toàn khác nhau và độc lập:

- **Mục tiêu của RSC:** Không thay thế SSR mà bổ sung (complement) cho SSR
- **Hoạt động cùng nhau:** Cả hai công nghệ đều có từ "server", nên có thể và nên được kết hợp
- **Framework cần thiết:** Next.js là framework kết hợp cả hai công nghệ này


### SSR hoạt động với RSC như thế nào

Khi framework kết hợp SSR với RSC:

**Trên initial render (lần render đầu tiên):**

- Cả server components và client components đều được render trên server
- Toàn bộ component tree được render thành HTML
- HTML được gửi đến browser

**Tại sao client components cũng render trên server?** Đây là điểm gây nhầm lẫn lớn nhất!

### Giải thích sự nhầm lẫn: React Server vs Web Server

Đây là phần quan trọng nhất cần hiểu:

**React Server và React Client không giống Web Server và Web Browser:**

- **React Server:** Đơn giản là một môi trường trong RSC protocol, một máy tính khác với browser mà developer có quyền truy cập và chạy code
- **React Client:** Phần của protocol tiêu thụ (consume) rendered React App

**Ý nghĩa thực tế:**

- React Server không nhất thiết phải là web server đang chạy
- Lý thuyết: Server và client components có thể được render một lần tại build time (Static Site Generation)
- Developer có thể đọc files từ file system của họ trong quá trình này
- Thực tế: RSC thường được kết hợp với SSR như đang mô tả

**React Client trong SSR:**

- Không nhất thiết phải là web browser
- Là phần của protocol render app thành HTML (không phải DOM elements)
- Trong SSR, cả hai môi trường (React Server và React Client) đều chạy trên web server của Next.js


### Quy trình hoàn chỉnh: SSR + RSC

**Bước 1: Initial render trên server**

```
Component Tree (Server + Client components)
  ↓ Render trên React Server và React Client
  ↓ (cả hai đều chạy trên web server)
HTML được tạo ra
  ↓
Gửi đến browser
```

**Bước 2: Gửi các tài nguyên bổ sung**

Sau khi HTML được gửi, server gửi thêm:

- **React bundle:** React library + component code (chia thành nhiều chunks)
- **Code splitting:** Client request các chunks khi cần thiết theo thời gian
- **RSC Payload:** Chứa:
    - Rendered server components
    - Props đã truyền từ server components đến client components
    - URL trỏ đến chunks tương ứng với mỗi client component

**Bước 3: Hydration**

- RSC Payload + React chunks được dùng để hydrate HTML
- **Chỉ client components được hydrate** (vì chỉ chúng mới có tính tương tác)
- Server components không cần hydrate

**Bước 4: Sau initial render**

- Có React App bình thường trong browser, tuân theo kiến trúc RSC
- React Server = Web server (nơi Next.js chạy)
- React Client = User's browser
- Khi server component re-render:
    - Tạo RSC Payload mới
    - Gửi đến browser
    - Merge vào React tree hiện có
    - Bảo toàn UI state


### Tóm tắt các điểm chính

**Điều quan trọng cần nhớ:**

- **Initial SSR:** Cả server và client components đều được render trên server
- **Sau khi app interactive:**
    - Server components chỉ chạy trên web server thật
    - Client components chỉ chạy trên browser thật
- **SSR chỉ liên quan đến initial render:** Sau đó, RSC hoạt động như đã học

**Quy tắc đơn giản:**

```javascript
// Initial render (SSR)
Web Server:
  - React Server renders server components
  - React Client renders client components → HTML
  - Send HTML + React bundle + RSC Payload to browser

// Sau initial render
Web Server:
  - Chỉ chạy server components
  - Gửi RSC Payload khi cần

Browser:
  - Chỉ chạy client components
  - Nhận và merge RSC Payload mới
```


### Lợi ích của việc kết hợp SSR + RSC

- **Performance:** HTML được gửi ngay lập tức, user thấy content nhanh
- **SEO:** Search engines có thể index HTML đầy đủ
- **Interactivity:** Client components vẫn có đầy đủ tính tương tác sau hydration
- **State preservation:** UI state được giữ nguyên khi server components re-render
- **Best of both worlds:** Tận dụng cả server và client để tối ưu trải nghiệm


### Ghi chú thêm

- Không cần hiểu sâu về cơ chế này để sử dụng server components trong Next.js
- Framework lo tất cả các chi tiết phức tạp về rendering, streaming, và code splitting
- Streaming và code splitting xảy ra tự động để tối ưu hiệu suất
- RSC Payload được thiết kế để nhẹ và dễ merge vào existing tree

**Liên kết:** [[Server-Side Rendering]], [[Hydration]], [[React Server]], [[React Client]], [[RSC Payload]], [[Static Site Generation]], [[Code Splitting]], [[Streaming]]

***

Bạn đã sẵn sàng bắt đầu xây dựng Wild Oasis website với những kiến thức về RSC và SSR này chưa?

