## Loading state toàn cục với `loading.js` trong Next.js

### Vấn đề: Trang tải dữ liệu bị trễ

- Trang `cabins` đang fetch dữ liệu `users`.
- Khi click vào link điều hướng đến trang này:
    - Có một độ trễ (khoảng 1 giây) trước khi nội dung được render.
- Trải nghiệm này không tốt, đặc biệt với:
    - Dữ liệu lớn
    - Nhiều request phức tạp
- Giải pháp: hiển thị **loading indicator** (vd: spinner, text “Loading…”) trong lúc dữ liệu đang được tải.

***

## `loading.js` – Convention cho loading UI

### Tạo global loading file

- Next.js cung cấp một convention đặc biệt:
    - Tạo file `loading.js` trong thư mục `app`:

Cấu trúc ví dụ:

```bash
app/
  layout.js
  page.js
  loading.js
```

- File `app/loading.js` là **global loader**:
    - Áp dụng cho **mọi page** trong ứng dụng.
    - Kể cả các route lồng sâu, ví dụ: `/cabins/test/23`.


### Định nghĩa component `Loading`

```jsx
// app/loading.js
export default function Loading() {
  return <p>LOADING DATA...</p>;
}
```

- Tên function (`Loading`) không bắt buộc, chỉ cần:
    - `export default` một React component.
- Khi bất kỳ page nào đang **load dữ liệu**:
    - Component trong `loading.js` sẽ được hiển thị tạm thời.

***

## Cách hoạt động của `loading.js` và streaming

### Hành vi hiển thị

- Khi reload hoặc chuyển sang một page có data fetching:
    - Phần nằm trong `layout.js`:
        - Navigation, header, footer,… → hiển thị **ngay lập tức**.
    - Phần nội dung của page (thân trang):
        - Tạm thời được thay bằng UI trong `loading.js` (ví dụ: `LOADING DATA`).
        - Khi dữ liệu tải xong:
            - Nội dung thật của page **tự động thay thế** UI loading.
- Tóm lại:
    - `loading.js` cho phép hiển thị một **instant loading state**:
        - Được render ngay trên server.
        - Sau đó bị thay bằng nội dung thực khi đã sẵn sàng.


### Streaming trong Next.js

- Việc xuất hiện `loading.js` **kích hoạt cơ chế streaming**:
    - HTML của trang không được gửi trong **một lần**.
    - Thay vào đó:
        - Một phần HTML (layout + loading UI) được stream trước.
        - Phần nội dung chính được stream tiếp khi sẵn sàng.
- Về kỹ thuật:
    - Trước đây demo thủ công dùng:
        - `renderToString` (từ `react-dom`) → tạo 1 chuỗi HTML duy nhất.
    - Next.js sử dụng:
        - `renderToReadableStream` (cũng từ `react-dom`) → hỗ trợ **streaming HTML**.
    - Nhờ vậy, browser nhận và hiển thị HTML dần dần, không phải chờ toàn bộ.


### Yêu cầu JavaScript

- Streaming + `loading.js` **cần JavaScript được bật** trên browser.
- Nếu người dùng **tắt JavaScript**:
    - Streaming sẽ **không hoạt động**.
    - Nếu muốn website vẫn chạy tốt **không cần JS**:
        - Không được dùng bất kỳ `loading.js` nào trong app.

***

## Streaming theo trang vs theo component (Suspense)

### Nhược điểm của `loading.js` toàn cục

- `loading.js` áp dụng cho **toàn bộ page**:
    - Nếu page có 20 component, chỉ 1 component fetch data:
        - Cả page vẫn bị thay bằng loading state ban đầu.
- Điều này thiếu “tinh chỉnh” (không granular):
    - Có thể không muốn che cả trang chỉ vì một phần nhỏ đang tải.


### Giải pháp chi tiết hơn: `Suspense`

- Để có mức kiểm soát chi tiết hơn:
    - Có thể dùng [[React Suspense]] cho từng component riêng lẻ.
    - Khi đó:
        - Chỉ vùng bọc bởi `<Suspense fallback={...}>` hiển thị loading.
        - Phần còn lại của page vẫn hiển thị ngay lập tức.
- Nội dung này sẽ được học kỹ hơn ở phần sau của khóa:
    - Cách kết hợp [[Suspense]] với [[React Server Components]] trong Next.js.
    - Cách streaming từng phần của UI một cách có chủ đích.

***

## Tóm tắt cách dùng `loading.js`

- Để có **loading indicator đơn giản toàn ứng dụng**:

1. Tạo file `app/loading.js`.
2. Export một component loader:

```jsx
export default function Loading() {
  return <p>LOADING DATA...</p>;
}
```

3. (Tùy chọn) sau này thay `<p>` bằng component Loader có CSS, animation,…
- Đặc điểm:
    - Tự động áp dụng cho **tất cả các route con**.
    - Kích hoạt **streaming** giữa server và client.
    - Chỉ áp dụng cho phần nội dung page, không ảnh hưởng layout.

***

**Liên kết:**
[[loading.js]], [[Streaming]], [[renderToReadableStream]], [[React DOM]], [[Layout]], [[Server Components]], [[Data Fetching]], [[Suspense]], [[JavaScript]], [[Next.js Routing]]

