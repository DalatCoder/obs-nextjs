## Thêm interactivity với Client Component (Counter)

### Giới thiệu

- Bài này minh họa:
    - Cách tạo một client component để thêm interactivity (tương tác) vào app.
    - Sự khác biệt giữa [[Server Component]] và [[Client Component]].
    - Cách “bắc cầu” dữ liệu từ server sang client thông qua props.
    - Mối liên hệ giữa [[Hydration]] và [[Server-side Rendering (SSR)]] trong bối cảnh [[React Server Components]].

***

## Không thể dùng React Hooks trong Server Component

### Hạn chế của Server Component

- Mặc định, page và nhiều component trong Next.js là [[Server Component]].
- Trong [[Server Component]]:
    - Không được dùng React hooks như `useState`, `useEffect`,...
    - Không được import các hook vào file server component.
- Khi cố gắng dùng `useState` trong server component:
    - Next.js báo lỗi:
        - “You’re importing a component that needs useState. It only works in a client component. But none of its parents are marked with use client. So this is a server component by default.”
    - Điều này nhắc lại quy tắc:
        - Muốn dùng hooks → component phải là [[Client Component]].
        - Và phải được đánh dấu bằng directive `"use client"`.

***

## Tạo Counter Client Component

### Tạo file client component

- Tạo file mới, ví dụ: `Counter.js`.
- Định nghĩa component với state:

```jsx
"use client";

import { useState } from "react";

export default function Counter() {
  const [count, setCount] = useState(0);

  return (
    <button onClick={() => setCount((c) => c + 1)}>
      Current count: {count}
    </button>
  );
}
```


### Các điểm quan trọng

- Dòng đầu tiên: `"use client"`
    - Đây là directive để nói với Next.js: file này là [[Client Component]].
    - Sau khi thêm, có thể:
        - Import và dùng `useState`, `useEffect`,...
        - Thêm event handler như `onClick`, `onChange`,...
- Cấu trúc counter:
    - `const [count, setCount] = useState(0);` → khởi tạo state.
    - `<button onClick={...}>` → tạo interactivity.
    - Mỗi lần click, `count` tăng 1.
- Khi import `Counter` vào một server component (ví dụ: page `CabinsPage`):
    - Page vẫn là server component.
    - `Counter` là client component con, được render và hydrate trên client.

***

## Hydration và hành vi khi mạng chậm

### Quy trình tải trang với Client Component

- Khi load trang ở chế độ mạng chậm (vd: Slow 3G):
    - B1: Trình duyệt tải HTML tĩnh do server render.
    - B2: Content tĩnh xuất hiện trên màn hình (bao gồm markup của `Counter`).
    - B3: Bundle React cho client được tải dần (JavaScript).
    - B4: Khi bundle được tải xong, React “hydrate”:
        - Gắn event handlers lại cho các client component.
        - Button bắt đầu hoạt động (click được, count tăng được).


### Ý nghĩa UX (trải nghiệm người dùng)

- Trước khi hydration xong:
    - Button có thể xuất hiện nhưng chưa hoạt động.
- Sau khi hydration hoàn tất:
    - Button trở nên interactive.
- Lợi ích:
    - Người dùng thấy nội dung quan trọng gần như ngay lập tức (SSR).
    - Interactivity đến sau khi JS tải xong, nhưng không chặn việc hiển thị nội dung.

***

## Bắt cầu Server ↔ Client bằng props

### Ý tưởng “Server–Client bridge”

- Trong kiến trúc [[React Server Components]]:
    - Dữ liệu thường được fetch ở [[Server Component]].
    - Sau đó truyền xuống [[Client Component]] qua props.
    - Các props này đóng vai trò như “cây cầu” bắc qua ranh giới server–client.


### Ví dụ truyền dữ liệu từ server component sang client component

Giả sử ở page (server component), ta fetch dữ liệu users:

```jsx
// Server Component (ví dụ: page.js)
export default async function CabinsPage() {
  const res = await fetch("https://jsonplaceholder.typicode.com/users");
  const users = await res.json();

  return (
    <main>
      <h1>Cabins</h1>
      <Counter users={users} />
    </main>
  );
}
```

Trong client component `Counter`:

```jsx
"use client";

import { useState } from "react";

export default function Counter({ users }) {
  const [count, setCount] = useState(0);

  console.log(users); // Log ở client console

  return (
    <>
      <p>There are {users.length} users.</p>
      <button onClick={() => setCount((c) => c + 1)}>
        Current count: {count}
      </button>
    </>
  );
}
```


### Các điểm quan sát quan trọng

- `console.log(users)` ở:
    - Server component → log xuất hiện trong terminal (server log).
    - Client component → log xuất hiện trong browser DevTools console.
- Cùng một dữ liệu `users`:
    - Được fetch ở server.
    - Được truyền qua props đến client component.
    - Được sử dụng để render nội dung như:
        - `There are {users.length} users.`

***

## Server-side Rendering và Client Components

### Điều gì xảy ra ở lần render đầu tiên?

- Ở lần truy cập đầu tiên:
    - Tất cả component (cả server lẫn client) đều được render trên server để tạo HTML.
    - Kể cả client component như `Counter`, phần output ban đầu (text) vẫn được server render thành HTML.
    - Ví dụ:
        - Câu `There are 10 users.` được render sẵn trên server và gửi xuống browser.
        - Người dùng thấy câu này ngay cả khi JS bundle (client) vẫn đang tải.
- Sau đó:
    - Khi JS bundle tải xong, client component được hydrate:
        - Gán logic `useState`, `onClick`,...
        - Biến các phần tử tĩnh thành tương tác.


### Kết nối với SSR và RSC

- SSR (Server-side Rendering):
    - Chịu trách nhiệm render HTML lần đầu trên server.
- React Server Components:
    - Cho phép fetch dữ liệu trực tiếp trong component phía server.
    - Tách biệt code chạy trên server và client rõ ràng.
- Client Components:
    - Nhận dữ liệu đã chuẩn bị sẵn từ server qua props.
    - Thêm interactivity sau khi hydrate.

***

## Tổng kết ý chính của bài

- Server component:
    - Không dùng được hooks như `useState`.
    - Không được import hooks vào file server.
- Client component:
    - Cần dùng directive `"use client"` ở đầu file.
    - Cho phép sử dụng hooks và event handlers.
- Hydration:
    - HTML và nội dung text xuất hiện trước.
    - Interactivity được “gắn” sau khi bundle React tải xong.
- Server–Client bridge:
    - Fetch dữ liệu ở server component.
    - Truyền xuống client component qua props (vd: `users`).
- SSR + RSC:
    - Tất cả component (kể cả client component) được render HTML trên server lần đầu.
    - Sau đó client component được hydrate để hoạt động trên browser.

***

**Liên kết:**
[[Server Component]], [[Client Component]], [[use client]], [[useState]], [[Hydration]], [[Server-side Rendering (SSR)]], [[React Server Components]], [[Data Fetching]], [[Props]], [[Interactivity]], [[Next.js]]

