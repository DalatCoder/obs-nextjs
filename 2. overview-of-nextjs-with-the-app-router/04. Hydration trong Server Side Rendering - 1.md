## Hydration trong Server Side Rendering

Bài học giải thích khái niệm hydration - một khía cạnh thiết yếu của Server Side Rendering (SSR), và cách nó giúp khôi phục tính tương tác cho trang web đã được render trên server.

### Vấn đề cần giải quyết

Trang web được server-side render từ bài trước không có tính tương tác - các button không hoạt động khi click. Nguyên nhân là vì SSR chỉ tạo ra HTML tĩnh, mất đi toàn bộ event handlers và logic React ban đầu.

### Hydration là gì?

Hydration là quá trình thêm lại tính tương tác (interactivity) và các event handlers cho HTML tĩnh đã được server-side render.

**Ẩn dụ**: Hydration giống như việc tưới nước cho cây khô - "tưới nước tương tác" vào DOM khô (HTML tĩnh) để làm cho nó "sống" trở lại.

### Quy trình Hydration hoạt động

**Bước 1: Render trên server**

- React app với component tree được render thành HTML markup trên server (thông qua Next.js hoặc framework tương tự)
- HTML này được gửi đến client

**Bước 2: Hiển thị HTML**

- Browser render HTML thành webpage
- Đạt được Largest Contentful Paint (LCP) - nội dung chính đã hiển thị
- Tuy nhiên, trang web vẫn chưa có tương tác

**Bước 3: Tải React bundle**

- Trang HTML download React bundle của app ban đầu
- Bundle này chứa toàn bộ logic React, state và event handlers

**Bước 4: Thực hiện hydration**

- React xây dựng lại component tree trên client
- So sánh component tree này với DOM đã được server render
- Nếu khớp nhau: React "nhận nuôi" (adopt) DOM hiện có thay vì tạo mới
- Gắn các event handlers và kích hoạt effects có sẵn

**Bước 5: Hoàn tất**

- Trang web trở nên tương tác đầy đủ (Time to Interactive - TTI)
- App hoạt động giống hệt React app ban đầu


### Lợi ích của Hydration

- Không cần tạo lại DOM elements từ đầu (tốn thời gian)
- Tận dụng HTML đã có sẵn từ server
- Chỉ cần gắn thêm interactivity vào DOM hiện tại
- Tăng hiệu suất tải trang


### Hydration Errors

Hydration errors xảy ra khi có sự không khớp giữa:

- DOM được server render
- DOM mà React tạo ra trên client

**Nguyên nhân phổ biến:**

```
- Nested HTML elements không đúng (ví dụ: `<div>` bên trong `<p>`)
```

- Render dữ liệu khác nhau trên server và client
- Sử dụng browser-only APIs như `window`, `localStorage` trong quá trình render
- Sử dụng side effects không đúng cách
- Thời gian render khác nhau (ví dụ: sử dụng `Date.now()`)

**Tại sao hydration errors là vấn đề?**

Hydration có thể mất vài giây. Nếu có sự khác biệt giữa hai DOM, nội dung trang sẽ thay đổi đột ngột sau khi hydration hoàn tất - gây trải nghiệm người dùng kém.

### Lưu ý

Đây là mô hình khái niệm về hydration, không phải cách Next.js (đặc biệt là App Router) hoạt động chính xác. Tuy nhiên, hiểu được khái niệm này giúp nắm vững cơ chế cơ bản của SSR.

Bài tiếp theo sẽ thực hành implement hydration thủ công bằng React hydration APIs trong project SSR demo.

**Liên kết:** [[Server Side Rendering]], [[React]], [[Hydration]], [[Next.js]], [[DOM]], [[Interactivity]], [[Largest Contentful Paint]], [[Time to Interactive]], [[Hydration Error]]

