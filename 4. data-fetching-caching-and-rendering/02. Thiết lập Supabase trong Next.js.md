## Thiết lập Supabase trong Next.js

### Giới thiệu

Bài học này hướng dẫn cách kết nối ứng dụng Next.js với cơ sở dữ liệu Supabase để lấy dữ liệu khách sạn (hotel data). Nếu đã hoàn thành dự án Wild Oasis ở phần 4 của khóa học, bạn sẽ có sẵn 4 bảng dữ liệu: bookings, cabins, guests và settings. Nếu chưa có, cần quay lại phần "Supabase Crash Course" để thiết lập.

### Cài đặt thư viện Supabase

Cài đặt package Supabase để kết nối với database:

```bash
npm install @supabase/supabase-js
```


### Tạo file cấu hình Supabase

Trong thư mục `lib` (library - chứa các file JavaScript hỗ trợ không phải component), tạo file `supabase.js`:

```javascript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY
)

export default supabase
```


### Environment Variables (Biến môi trường)

Next.js hỗ trợ sẵn biến môi trường (environment variables), cho phép lưu trữ thông tin nhạy cảm một cách an toàn.

#### Tạo file .env.local

Tạo file `.env.local` ở thư mục gốc của dự án:

```
SUPABASE_URL=your_supabase_project_url
SUPABASE_KEY=your_service_role_key
```


#### Cách hoạt động

- Biến môi trường được Node.js load từ file `.env.local`
- Truy cập thông qua `process.env.TEN_BIEN`
- Sử dụng quy ước đặt tên: chữ HOA và dấu gạch dưới `_`


#### Phân biệt Public và Private variables

**Biến Private (mặc định)**

- Chỉ khả dụng trên server
- Không bị lộ ra browser
- Bảo mật thông tin nhạy cảm

**Biến Public**

- Thêm prefix `NEXT_PUBLIC_` vào tên biến
- Ví dụ: `NEXT_PUBLIC_API_URL`
- Có thể truy cập từ browser
- Dùng cho thông tin không nhạy cảm


### Row Level Security và Service Role Key

#### Vấn đề với Public Key

Trong dự án Wild Oasis trước đây, các bảng dữ liệu được bảo vệ bởi [[Row Level Security]] (RLS), chỉ cho phép người dùng đã xác thực (authenticated users) truy cập. Tuy nhiên, với website khách sạn công khai, cần cho phép mọi người xem thông tin cabin mà không cần đăng nhập.

#### Giải pháp: Service Role Key

Supabase cung cấp hai loại key:

**Public Key (anon key)**

- Dùng cho ứng dụng client-side thông thường
- Bị giới hạn bởi RLS policies
- An toàn để lộ ra browser

**Service Role Key**

- Có quyền bypass (bỏ qua) RLS
- Truy cập toàn bộ dữ liệu không giới hạn
- **Phải giữ bí mật tuyệt đối**


#### Lấy Service Role Key

Trong Supabase Dashboard:

1. Vào **Project Settings** → **API**
2. Tìm mục **service_role key**
3. Click **Reveal** để hiển thị
4. Copy và paste vào `.env.local`
```
SUPABASE_KEY=your_service_role_key_here
```


### Lưu ý bảo mật quan trọng

⚠️ **Service Role Key có quyền truy cập toàn bộ database**

- Tuyệt đối không để lộ key này ra browser
- Không commit file `.env.local` lên Git (thêm vào `.gitignore`)
- Chỉ lưu trong biến môi trường private (không có prefix `NEXT_PUBLIC_`)
- Kẻ xấu có được key này sẽ có toàn quyền với dữ liệu của bạn


### Tạo Data Service

Trong file `lib/data-service.js`, import Supabase client để sử dụng:

```javascript
import supabase from './supabase'

export async function getCabins() {
  const { data, error } = await supabase
    .from('cabins')
    .select('*')
  
  if (error) {
    console.error(error)
    throw new Error('Cabins could not be loaded')
  }
  
  return data
}

// Các hàm khác: getBookings, createGuest, createBooking...
```


### Sử dụng trong Server Components

Sau khi thiết lập xong, có thể fetch dữ liệu trong [[Server Components]] và truyền xuống [[Client Components]] qua props:

```javascript
// app/cabins/page.js
import { getCabins } from '@/lib/data-service'

export default async function CabinsPage() {
  const cabins = await getCabins()
  
  return (
    <div>
      {cabins.map(cabin => (
        <CabinCard key={cabin.id} cabin={cabin} />
      ))}
    </div>
  )
}
```


### Ghi chú thêm

- File `.env.local` chỉ hoạt động trong môi trường development
- Với production, cần cấu hình biến môi trường trên hosting platform (Vercel, Netlify...)
- Các hàm trong `data-service.js` tương tự như trong dự án Wild Oasis trước đó
- Next.js tự động load biến môi trường khi khởi động server

**Liên kết:** [[Supabase]], [[Next.js]], [[Environment Variables]], [[Row Level Security]], [[Server Components]], [[Client Components]], [[API Keys]], [[Database Security]]

