## Dynamic Route Segments (Phân đoạn Route động) trong Next.js

### Giới thiệu

Khi xây dựng các trang cabin riêng lẻ, chúng ta cần học về **Dynamic Route Segments** (Phân đoạn route động). Đây là cơ chế cho phép tạo các route với phần URL không xác định trước, ví dụ: `/cabins/91`, `/cabins/89`, `/cabins/90` - trong đó số ID thay đổi tùy theo cabin cụ thể.

Vấn đề đặt ra: Không thể tạo trước 20 folder con bên trong `cabins` cho 20 ID khác nhau. Thay vào đó, phần động này sẽ được điền vào tại thời điểm request hoặc có thể được pre-render.

### Cách triển khai Dynamic Segment

#### Tạo cấu trúc thư mục

Để tạo dynamic route segment, sử dụng cú pháp **square brackets** (dấu ngoặc vuông):

```
cabins/
  [cabinId]/
    page.js
```

- Tên bên trong ngoặc vuông (`cabinId`) chính là tên bạn muốn đặt cho phần động của URL
- Đây là một child route của `cabins`, nên cần tạo folder con bên trong `cabins`


#### Truy cập giá trị động qua params

Bất kỳ page hoặc layout nào liên kết với dynamic route segment đều có quyền truy cập vào prop `params`:

```javascript
export default async function Page({ params }) {
  console.log(params); // { cabinId: '91' }
  
  // Fetch dữ liệu dựa trên ID động
  const cabin = await getCabin(params.cabinId);
  
  return (
    <div>
      {/* Render cabin data */}
    </div>
  );
}
```

**Lưu ý quan trọng:**

- Tên property trong `params` phải khớp với tên folder dynamic segment
- Nếu folder là `[id]` thì truy cập qua `params.id`
- Nếu folder là `[cabinId]` thì truy cập qua `params.cabinId`


### Fetch dữ liệu động

Component cần trở thành **async function** để có thể sử dụng `await`:

```javascript
export default async function Page({ params }) {
  // Fetch dữ liệu cabin cụ thể
  const cabin = await getCabin(params.cabinId);
  
  return (
    <div>
      <h1>{cabin.name}</h1>
      <p>{cabin.description}</p>
      {/* Các thông tin khác */}
    </div>
  );
}
```

Lợi ích của server component: có thể sử dụng cú pháp `async/await` trực tiếp trong React component một cách tự nhiên.

### Loading States

File `Loading.js` trong folder cha (`cabins/Loading.js`) sẽ áp dụng cho:

- Route hiện tại (`/cabins`)
- Tất cả child routes (`/cabins/[cabinId]`)

Trừ khi child route có `Loading.js` riêng. Điều này giúp hiển thị trạng thái loading nhất quán cho cả section.

```javascript
// cabins/Loading.js
export default function Loading() {
  return <p>Loading cabin data...</p>;
}
```


### Xử lý Image Component

Khi sử dụng Next.js Image component, cần chỉ định kích thước hoặc dùng `fill`:

```javascript
import Image from 'next/image';

<div className="relative">
  <Image
    src={cabin.image}
    fill
    className="object-cover"
    alt={cabin.name}
  />
</div>
```

**Yêu cầu khi dùng `fill`:**

- Container cha phải có `position: relative`
- Sử dụng `object-cover` để image fill đúng không gian


### So sánh với React Router

Trong React Router (client-rendered application), dynamic routes cũng hoạt động tương tự nhưng cách triển khai khác:

- Next.js: Dựa trên **conventions** (quy ước) về cấu trúc folder
- React Router: Cấu hình qua code

Next.js đơn giản và trực quan hơn nhờ file-system based routing.

### Ví dụ hoàn chỉnh

```javascript
// app/cabins/[cabinId]/page.js
import Image from 'next/image';
import { getCabin } from '@/data-service';

export default async function Page({ params }) {
  const cabin = await getCabin(params.cabinId);
  
  return (
    <div className="cabin-detail">
      <div className="relative h-96">
        <Image
          src={cabin.image}
          fill
          className="object-cover"
          alt={cabin.name}
        />
      </div>
      
      <h1>{cabin.name}</h1>
      <p>Max capacity: {cabin.maxCapacity}</p>
      <p>Regular price: ${cabin.regularPrice}</p>
      <p>{cabin.description}</p>
    </div>
  );
}
```


### Ghi chú thêm

- Dynamic segments hoạt động cho mọi trường hợp có thể
- Giá trị được đọc từ URL và đưa vào `params` tự động
- Cơ chế này được sử dụng rất thường xuyên trong Next.js applications
- Trong development mode, caching có thể không hoạt động như production

**Liên kết:** [[Next.js]], [[Dynamic Routes]], [[Server Components]], [[File-system Routing]], [[Image Optimization]], [[Loading States]], [[Async Server Components]], [[Params Prop]]

