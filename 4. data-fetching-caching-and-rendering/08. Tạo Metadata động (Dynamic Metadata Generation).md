## Tạo Metadata động (Dynamic Metadata Generation)

### Vấn đề ban đầu

Khi truy cập các trang cabin riêng lẻ (ví dụ: `/cabins/91`), title của trang luôn hiển thị "Welcome" - đây là giá trị mặc định. Trong khi đó, trang `/cabins` có title "Cabins". Điều này không lý tưởng vì mỗi trang cabin nên có title riêng biệt phản ánh tên cabin cụ thể.

### Giải pháp: Export metadata tĩnh (không đủ)

Cách tiếp cận đầu tiên là export biến `metadata`:

```javascript
// app/cabins/[cabinId]/page.js
export const metadata = {
  title: 'Cabin'
};
```

**Hạn chế:** Title vẫn chung chung, không thể hiện tên cabin cụ thể như "Cabin 004".

### Giải pháp tối ưu: generateMetadata Function

Next.js cung cấp convention **generateMetadata** - một hàm cho phép tạo metadata động dựa trên dữ liệu runtime.

#### Cấu trúc cơ bản

```javascript
// app/cabins/[cabinId]/page.js
export async function generateMetadata({ params }) {
  // Fetch dữ liệu cabin
  const { name } = await getCabin(params.cabinId);
  
  // Return metadata object
  return {
    title: `Cabin ${name}`
  };
}

export default async function Page({ params }) {
  const cabin = await getCabin(params.cabinId);
  return <div>{/* render cabin */}</div>;
}
```


#### Đặc điểm quan trọng

**Async function:** `generateMetadata` là hàm async, cho phép fetch dữ liệu từ API hoặc database để tạo metadata động.

**Params access:** Function nhận prop `params` giống như Page component, có thể truy cập dynamic route parameters.

**Return object:** Trả về object có cấu trúc tương tự static metadata, bao gồm các thuộc tính như `title`, `description`, `openGraph`, etc.

### Cơ chế hoạt động

Next.js xử lý metadata động theo trình tự:

1. Đợi `generateMetadata` fetch dữ liệu và hoàn thành
2. Tạo correct head tags với metadata vừa tạo
3. Stream UI content đến client

Điều này đảm bảo phần đầu tiên của response luôn chứa thông tin head chính xác, quan trọng cho SEO và social sharing.

### Ví dụ nâng cao

```javascript
export async function generateMetadata({ params }) {
  const cabin = await getCabin(params.cabinId);
  
  return {
    title: `Cabin ${cabin.name}`,
    description: `Book ${cabin.name} - Max capacity ${cabin.maxCapacity} guests`,
    openGraph: {
      title: `Cabin ${cabin.name}`,
      description: cabin.description,
      images: [cabin.image],
    },
  };
}
```


### Lưu ý về Performance

**Caching:** Next.js tự động cache kết quả của `generateMetadata` để tránh fetch dữ liệu lặp lại không cần thiết.

**Title flicker:** Trong development mode, có thể thấy title mặc định hiển thị tạm thời trước khi metadata động được load. Đây là hành vi bình thường và khó tránh khỏi, nhưng hy vọng Next.js sẽ cải thiện trong tương lai.

### So sánh hai cách

**Static metadata (export metadata):**

- Đơn giản, phù hợp cho pages có metadata cố định
- Không cần fetch dữ liệu
- Performance tốt nhưng thiếu tính linh hoạt

**Dynamic metadata (generateMetadata):**

- Linh hoạt, có thể sử dụng dữ liệu runtime
- Cần fetch dữ liệu (async operation)
- Phù hợp cho dynamic routes với nội dung thay đổi


### Khi nào sử dụng

Sử dụng `generateMetadata` khi:

- Page có dynamic route parameters
- Title/description phụ thuộc vào dữ liệu database
- Cần tạo Open Graph tags cho social media
- SEO yêu cầu metadata cụ thể cho từng page

**Liên kết:** [[Next.js]], [[Metadata]], [[Dynamic Routes]], [[SEO]], [[generateMetadata]], [[Server Components]], [[Async Functions]], [[Page Title]], [[Open Graph]]

