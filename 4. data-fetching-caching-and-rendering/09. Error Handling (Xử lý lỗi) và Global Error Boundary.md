## Error Handling (Xử lý lỗi) và Global Error Boundary

### Giới thiệu

Khi ứng dụng đã hoạt động cơ bản với việc render dữ liệu về cabins và hotel, cần thiết lập **error handling** (xử lý lỗi) để đảm bảo trải nghiệm người dùng tốt hơn. Cụ thể là thiết lập **global error boundary** (ranh giới lỗi toàn cục) để bắt và xử lý các lỗi phát sinh trong ứng dụng.

### Các tình huống lỗi thường gặp

#### Lỗi ID không tồn tại

Người dùng truy cập URL với ID cabin không tồn tại (ví dụ: đã bookmark URL cũ nhưng ID đã thay đổi). Khi fetch dữ liệu, kết quả trả về `null` và không thể destructure, gây ra lỗi trong `generateMetadata` function.

#### Lỗi logic code

Ví dụ: Developer nhầm lẫn cấu trúc dữ liệu:

```javascript
// Sai: capacity là object
<p>{cabin.capacity.max}</p>

// Đúng: maxCapacity là property trực tiếp
<p>{cabin.maxCapacity}</p>
```

Những lỗi như vậy có thể bị bỏ sót trong development và xuất hiện ở production, khiến người dùng gặp error screen không thân thiện.

### Tạo Global Error Boundary

#### Sử dụng convention file Error.js

Next.js cung cấp convention file `Error.js` để tự động wrap toàn bộ application vào React error boundary:

```javascript
// app/error.js
'use client';

export default function Error({ error, reset }) {
  return (
    <div className="error-container">
      <h2>Something went wrong!</h2>
      <p>{error.message}</p>
      <button onClick={() => reset()}>
        Try again
      </button>
    </div>
  );
}
```


#### Yêu cầu: Client Component

**Quan trọng:** Error boundary **phải là client component** vì:

- Nhận props `error` (object chứa thông tin lỗi) và `reset` (function để reset error boundary)
- Xử lý tương tác người dùng (onClick handler)
- Các tương tác này chỉ có thể xảy ra trong client component

```javascript
'use client'; // Bắt buộc phải có directive này
```


### Props của Error Component

**error object:** Chứa thông tin về lỗi xảy ra, có thể truy cập `error.message` để hiển thị chi tiết lỗi cho developer hoặc thông báo thân thiện cho user.

**reset function:** Khi gọi, sẽ thử reset error boundary và re-render component. Tương tự như reload trang, nhưng không phải lúc nào cũng giải quyết được vấn đề. Có thể cân nhắc redirect user về homepage thay vì chỉ reset.

### Nested Error Boundaries

Giống như `layout.js` và `loading.js`, có thể tạo nhiều error boundaries ở các cấp độ khác nhau trong cấu trúc folder:

```
app/
  error.js           (Global error boundary)
  cabins/
    error.js         (Error boundary cho /cabins)
    [cabinId]/
      error.js       (Error boundary cho cabin detail)
      page.js
```

Error boundary gần nhất sẽ được sử dụng khi lỗi xảy ra. Với ứng dụng đơn giản, chỉ cần global error boundary là đủ.

### Giới hạn của Error Boundary

#### Chỉ bắt lỗi trong rendering

Error boundary **chỉ bắt lỗi xảy ra trong quá trình rendering**, không bắt lỗi trong:

- Event handlers (onClick, onChange, etc.)
- Async callbacks
- Timers (setTimeout, setInterval)

Ví dụ lỗi **KHÔNG** bị bắt:

```javascript
function Component() {
  const handleClick = () => {
    throw new Error('Error in callback'); // Không bị bắt
  };
  
  return <button onClick={handleClick}>Click</button>;
}
```


#### Không bắt lỗi trong Root Layout

`Error.js` **không bắt lỗi xảy ra trong root layout** (`app/layout.js`). Nếu fetch dữ liệu trong root layout và xảy ra lỗi, error boundary thông thường không handle được.

### Global Error (global-error.js)

Để bắt cả lỗi trong root layout, cần tạo `global-error.js`:

```javascript
// app/global-error.js
'use client';

export default function GlobalError({ error, reset }) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  );
}
```

**Đặc điểm quan trọng:**

- Thay thế toàn bộ root layout khi lỗi xảy ra

```
- Phải tự định nghĩa `<html>` và `<body>` tags
```

- Chỉ cần thiết cho các ứng dụng phức tạp có logic quan trọng trong root layout


### Best Practices

**Thông báo lỗi rõ ràng:** Trong development, hiển thị `error.message` chi tiết. Trong production, cân nhắc thông báo thân thiện hơn cho user.

**Styling nhất quán:** Error component nên có styling giống phần còn lại của website để duy trì trải nghiệm nhất quán.

**Có thể tái sử dụng:** Error boundary này có thể copy-paste vào các Next.js projects khác trong tương lai.

**Xử lý Not Found riêng:** Lỗi "page not found" nên xử lý riêng bằng `not-found.js` thay vì error boundary chung.

### Project Structure Documentation

Next.js cung cấp documentation đầy đủ về các convention files:

- `error.js` - Error boundary thông thường
- `global-error.js` - Bắt lỗi trong root layout
- `not-found.js` - Xử lý 404 errors
- `loading.js` - Loading states
- `layout.js` - Shared layouts
- `template.js` - Re-render on navigation
- `default.js` - Fallback for parallel routes
- `route.js` - API route handlers

Tất cả các conventions này đều có thể tìm trong Next.js documentation, phần "Project Structure".

### Ghi chú thêm

- Error screen trong development khác với production
- Development mode hiển thị stack trace chi tiết, production mode hiển thị thông báo generic hơn
- Luôn test error handling trong cả development và production mode

**Liên kết:** [[Next.js]], [[Error Boundary]], [[Error Handling]], [[Client Components]], [[Global Error]], [[Not Found]], [[React Error Boundary]], [[Project Structure]], [[Convention Files]]

