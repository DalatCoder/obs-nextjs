## Sử dụng Client Component trong Server Component

### Giới thiệu

Bài học này minh họa cách sử dụng [[Client Component]] bên trong [[Server Component]] trong NextJS, và cách áp dụng kiến thức về ranh giới client-server đã học trước đó.

### Tình huống thực tế: Text Expander

#### Yêu cầu chức năng

Trong trang cabins, cần tạo tính năng mở rộng văn bản:

- Ban đầu chỉ hiển thị phần preview ngắn của text (40 từ đầu)
- Có nút bấm để người dùng mở rộng và xem toàn bộ text
- Đây là tính năng tương tác (interactive) cần JavaScript/React
- Không thể render trên server → cần Client Component


#### Cấu trúc component

**Page Component (Server Component)** chứa **TextExpander (Client Component)**

### Triển khai TextExpander Component

#### Code mẫu

```jsx
'use client'

import { useState } from 'react'

function TextExpander({ children }) {
  const [isExpanded, setIsExpanded] = useState(false)
  
  const displayText = isExpanded 
    ? children 
    : children.split(' ').slice(0, 40).join(' ') + '...'
  
  return (
    <div>
      <p>{displayText}</p>
      <button onClick={() => setIsExpanded(!isExpanded)}>
        {isExpanded ? 'Show less' : 'Read more'}
      </button>
    </div>
  )
}

export default TextExpander
```


#### Sử dụng trong Page Component

```jsx
// page.js - Server Component
import TextExpander from '@/components/TextExpander'

export default function Page() {
  const description = "Long text content here..."
  
  return (
    <div>
      <TextExpander>
        {description}
      </TextExpander>
    </div>
  )
}
```


### Xử lý lỗi và giải pháp

#### Lỗi phổ biến

Khi chưa có directive `'use client'`, sẽ nhận được lỗi:

```
You're importing a component that needs useState.
It only works in a Client Component, but none of its 
parents are marked with "use client," so they're 
Server Components by default.
```


#### Giải pháp

Thêm directive `'use client'` ở đầu file TextExpander:

- Tạo ranh giới server-client boundary tại component này
- Dữ liệu (description text) được truyền từ server sang client qua props
- Component và tất cả children của nó trở thành Client Components


### Best Practice: Đặt Client Component thấp nhất có thể

#### Nguyên tắc

Luôn đặt Client Component càng thấp trong component tree càng tốt vì:

- Tất cả component con của Client Component tự động trở thành Client Component
- Các component con này sẽ không được render trên server
- Server rendering giúp trang load nhanh hơn


#### Trường hợp TextExpander

Component này nằm ở "leaf" (lá) của cây component - không có component con nào bên trong, nên đây là vị trí hợp lý.

### Demo: Component có thể là cả Server và Client Instance

#### Thí nghiệm với Logo Component

**Thêm Logo vào TextExpander**:

```jsx
'use client'

import { useState } from 'react'
import Logo from './Logo'

function TextExpander({ children }) {
  // ... code như trên
  
  return (
    <div>
      <p>{displayText}</p>
      <button onClick={() => setIsExpanded(!isExpanded)}>
        {isExpanded ? 'Show less' : 'Read more'}
      </button>
      <Logo /> {/* Thêm để test */}
    </div>
  )
}
```


#### Kết quả

Logo Component xuất hiện ở hai vị trí:

- **Trong Header**: Là Server Component instance (vì Header là Server Component)
- **Trong TextExpander**: Là Client Component instance (vì TextExpander có `'use client'`)


#### Giải thích

Logo Component không có directive `'use client'`:

- Khi được import bởi Server Component → tạo server instance
- Khi được import bởi Client Component → tạo client instance (vì đã vượt qua server-client boundary)
- **Quan trọng**: Đây là các **instance** khác nhau của cùng một component


### Kiểm tra với Console Logs

Để xác minh component render ở đâu, thêm `console.log()`:

```jsx
function Logo() {
  console.log('LOGO')
  return <img src="/logo.png" alt="Logo" />
}
```

**Kết quả quan sát**:

- Logs xuất hiện ở **terminal/server console**: Từ Server Component instance (render trên server)
- Logs xuất hiện ở **browser console**: Từ Client Component instance (render trên client)

**Phân biệt**:

- Server logs: Tất cả Server Component instances
- Browser console logs: Chỉ từ Client Components


### Tổng kết

#### Điểm chính

- Client Components cần thiết cho tính năng tương tác (useState, onClick...)
- Sử dụng directive `'use client'` để tạo ranh giới client-server
- Một component definition có thể tạo ra cả server instance và client instance
- Nên đặt Client Component càng thấp trong cây càng tốt
- Console logs giúp xác định component render ở server hay client


#### Nguyên tắc thiết kế

Client Components hoàn toàn hợp lệ và cần thiết trong hầu hết ứng dụng, nhưng nên sử dụng có chọn lọc để tối ưu hiệu suất server rendering.

**Liên kết:** [[Client Component]], [[Server Component]], [[Use Client Directive]], [[useState]], [[Server-Client Boundary]], [[Component Instance]], [[React Developer Tools]], [[Server Rendering]], [[Component Tree]]

